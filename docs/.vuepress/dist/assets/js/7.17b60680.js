(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{441:function(s,t,a){"use strict";a.r(t);var n=a(12),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"mysql索引详解"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql索引详解"}},[s._v("#")]),s._v(" MySQL索引详解")]),s._v(" "),a("h2",{attrs:{id:"常见的索引模型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#常见的索引模型"}},[s._v("#")]),s._v(" 常见的索引模型")]),s._v(" "),a("p",[s._v("索引的出现是为了提高查询效率，但是实现索引的方式却很多，所以这里也就引入了索引模型的概念。可用于提高读写效率的数据结构有很多，这里有三种常见的数据结构作为索引来使用，分别是哈希表，有序数组和搜索树。")]),s._v(" "),a("p",[s._v("哈希表是一种以键值对存储的数据结构，用hash函数把key换算成一个确定的位置，然后把value放在数组的这个位置上。")]),s._v(" "),a("p",[s._v("多个key经过哈希函数的计算可能会出现同一个值。处理这种情况的方法是，拉出一个链表。")]),s._v(" "),a("p",[s._v("但是这个链表对于增加的新节点很快，缺点是因为链表不是有序的，所以索引做区间查询的速度是很慢的。")]),s._v(" "),a("p",[s._v("因此哈希表这个结构适用于只有等值查询的场景。比如Memcached以及一些NoSQL引擎。")]),s._v(" "),a("p",[s._v("而有序数组在等值查询和范围查询场景中的性能就是非常优秀的。")]),s._v(" "),a("p",[s._v("因为这个索引如果是递增的顺序，我们就可以用二分查找找出对应的值，时间复杂度是O(logN)。")]),s._v(" "),a("p",[s._v("同时，这个索引支持范围查询，你要查身份证号在[x,y]区间的User，可以先用二分查找找到x，然后向右遍历，查到第一个大于y的值，退出循环。")]),s._v(" "),a("p",[s._v("如果仅仅看查询效率，有序数组就是最好的数据结构了，但是在需要更新数据的时候就很麻烦。因为数组增加一个值，需要往后挪动所有的记录，成本太高。")]),s._v(" "),a("p",[s._v("因此，有序数组索引只适用于静态存储引擎。")]),s._v(" "),a("p",[s._v("第三种是二叉搜索树。他的特点就是左孩子节点小于父节点，右孩子节点大于父节点。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/bailefolen/typora-pictures/raw/master/typora-pictures/img/image-20201011202143603.png",alt:"image-20201011202143603"}})]),s._v(" "),a("p",[s._v("要想查User2的ID_card，搜索顺序就是 UserA->UserC->UserF->User2.时间复杂度是O(log(N))。")]),s._v(" "),a("p",[s._v("要想维持这个查询复杂度，就需要保证这始终是一颗平衡二叉树。为了做这个保证，更新的时间复杂度也是O(log(N))。")]),s._v(" "),a("p",[s._v("虽然二叉树搜索效率很高，但是实际上大多数的数据库存储并不是使用二叉树作为存储，因为索引不止存在于内存中，还要写在磁盘上。")]),s._v(" "),a("p",[s._v("为了再查询时尽量少读磁盘，就必须让查询过程访问尽量少的数据块。那么就要使用N叉树。N的大小取决于数据块的大小。")]),s._v(" "),a("p",[s._v("数据库底层存储的核心是基于这些数据结构的。")]),s._v(" "),a("h2",{attrs:{id:"innodb索引模型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#innodb索引模型"}},[s._v("#")]),s._v(" InnoDB索引模型")]),s._v(" "),a("p",[s._v("表都是根据主键顺序以索引的形式存放的。这种存储方式的表称为索引组织表。InnoDB使用了B+树索引模型，因此数据都是存储在B+树中的。")]),s._v(" "),a("p",[s._v("每个索引在InnoDB里面对应一棵B+树。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("mysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" T"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\nid "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("primary")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \nk "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("not")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" \nname "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varchar")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("k"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("engine")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("InnoDB")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("表中 R1~R5 的 (ID,k) 值分别为 (100,1)、(200,2)、(300,3)、(500,5) 和 (600,6)，两棵树的示例示意图如下。")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/bailefolen/typora-pictures/raw/master/typora-pictures/img/image-20201011203259230.png",alt:"image-20201011203259230"}})]),s._v(" "),a("p",[s._v("索引分为两种，一种是主键索引，一种是非主键索引。")]),s._v(" "),a("p",[s._v("主键索引的叶子结点存的是整行数据，在InnoDB里面，主键索引也被叫做聚簇索引。非主键索引的叶子结点存储的是主键的值，在InnoDB里面，非主键索引也被称为二级索引。")]),s._v(" "),a("p",[s._v("说了这么多，这俩到底有啥区别？")]),s._v(" "),a("p",[s._v("举个例子来说。")]),s._v(" "),a("p",[s._v("如果语句是"),a("code",[s._v("select * from T where ID=500")]),s._v("，这是主键查询的方式，只需要搜索ID这颗B+树；")]),s._v(" "),a("p",[s._v("如果语句是\t"),a("code",[s._v("select * from T where k=5")]),s._v("也就是使用普通索引查询，需要先搜索k这颗索引树，得到ID的值是500，再到ID索引树搜索一次，这个过程叫做回表。")]),s._v(" "),a("p",[s._v("也就是说，基于非主键索引的查询需要多扫描一棵索引树。因此，我们在应用中应该尽量使用主键查询。")]),s._v(" "),a("h2",{attrs:{id:"索引的维护"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#索引的维护"}},[s._v("#")]),s._v(" 索引的维护")]),s._v(" "),a("p",[s._v("B+树为了维护索引的有序性，如果新增的记录可以放在当前数据页，这个比较简单，但是如果当新增的记录加上去后，当前页已满，根据B+树的算法，这时候需要申请一个新的数据页，然后挪动部分数据过去，这个过程叫做页分裂。")]),s._v(" "),a("p",[s._v("页分裂这玩意儿，除了影响性能外还影响数据页的利用率，原本放在一个页的数据，现在分到两个页中，整体空间利用率降低了50%。")]),s._v(" "),a("p",[s._v("既然有分裂就会有合并，当相邻两个页由于删除了数据，利用率很低之后，会将数据页合并。合并的过程，就是分裂过程的可逆。")]),s._v(" "),a("p",[s._v("自增主键，也就是如果不指定id的值，系统会获取当前id最大值加1作为下一条记录的ID值。")]),s._v(" "),a("p",[s._v("自增主键的插入数据模式，正符合我们前面提到的递增插入的场景。每次插入一条记录，都是追加的操作，都不涉及挪动其它记录，也不会触发叶子结点的分裂。")]),s._v(" "),a("p",[s._v("业务逻辑的字段做主键，则往往不容易保证有序插入，这样写数据成本相对较高。")]),s._v(" "),a("p",[s._v("除了考虑性能外，我们还可以从存储空间的角度来看。")]),s._v(" "),a("p",[s._v("直接说结论吧，主键长度越小，普通索引的叶子结点就越小，普通索引占用的空间也就越小。")]),s._v(" "),a("p",[s._v("操作索引")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alter")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" T "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("drop")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v(" k"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 删除索引")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alter")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" T "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("add")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("k"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--增加索引")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("主键索引")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alter")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" T "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("drop")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("primary")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alter")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" T "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("add")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("primary")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h2",{attrs:{id:"覆盖索引"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#覆盖索引"}},[s._v("#")]),s._v(" 覆盖索引")]),s._v(" "),a("p",[a("code",[s._v("select * from t where k between 3 and 5")])]),s._v(" "),a("p",[s._v("先看上面这一条SQL语句的执行流程。")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("在k索引树上找到k=3的记录，取得ID=300；")])]),s._v(" "),a("li",[a("p",[s._v("再到ID索引树查到ID=300对应的值")])]),s._v(" "),a("li",[a("p",[s._v("在k索引树取下一个值k=5，取得ID=500；")])]),s._v(" "),a("li",[a("p",[s._v("再回到ID索引树查到ID=500对应的R4。")])]),s._v(" "),a("li",[a("p",[s._v("在k索引树取k=6不满足条件，退出循环。")])])]),s._v(" "),a("p",[s._v("在这个过程中，返回主键索引树了两次，也就是回表了两次。")]),s._v(" "),a("p",[s._v("如果执行语句改为"),a("code",[s._v("select ID from t where k between 3 and 5")]),s._v("，这时候只需要查ID的值，而ID是组件，已经在普通索引树上了，因此可以直接提供查询结果，不需要回表。因为索引k覆盖了我们的查询需求，所以我们称为覆盖索引。")]),s._v(" "),a("p",[s._v("因为覆盖索引可以减少回表次数，所以可以用来做性能优化。")]),s._v(" "),a("h2",{attrs:{id:"最左前缀匹配原则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#最左前缀匹配原则"}},[s._v("#")]),s._v(" 最左前缀匹配原则")]),s._v(" "),a("p",[s._v("1、B+树的最左前缀匹配的原因")]),s._v(" "),a("p",[s._v("MySQL创建联合索引的规则是根据索引最左边的字段进行排序，在第一个字段排序的基础上再进行第二个字段的排序，类似于order by col1,clo2所以第一个字段是绝对有序的，第二个字段就是无序的，所以MySQL强调最左前缀匹配。")]),s._v(" "),a("p",[s._v("比如a=3 and b=4 and c>5 and d=6，如果建立abcd的联合索引，d就用不到索引，因为MySQL会一直向右匹配直到遇到范围查询（between and ，>， <， like）。")]),s._v(" "),a("h2",{attrs:{id:"索引下推"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#索引下推"}},[s._v("#")]),s._v(" 索引下推")]),s._v(" "),a("p",[s._v("建一张市民表")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("tuser"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id_card"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varchar")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varchar")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("age"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("ismale"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("tinyint")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PRIMARY")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("KEY")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("KEY")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id_card"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("id_card"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("KEY")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("name_age"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),s._v("age"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("`")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ENGINE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("InnoDB")]),s._v("\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("现在要查姓张的男孩年龄还必须是10岁的，SQL可以这么写")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("\nmysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" tuser "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'张 %'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("and")]),s._v(" age"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("and")]),s._v(" ismale"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v('这个语句在搜索 索引树的时候，只能用"张",找到第一个满足条件的记录ID3，当然这种笔全表扫描要好。然后再判断剩下的条件是否满足，在MySQL5.6版本之前只能根据name查到ID3，剩下的条件需要一次一次回表判断才能最终找出结果。但是在MySQL5.6引入下推优化，可以减少回表的次数。')]),s._v(" "),a("p",[s._v("5.6之前，不会向后判断age，而是直接回表查询\n"),a("img",{attrs:{src:"https://gitee.com/bailefolen/typora-pictures/raw/master/typora-pictures/img/2020050122433743.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("p",[s._v("5.6之后，会向后判断age=10的人，然后再回表，这样就减少了回表的次数")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://gitee.com/bailefolen/typora-pictures/raw/master/typora-pictures/img/20200501224320395.png",alt:"在这里插入图片描述"}})]),s._v(" "),a("h2",{attrs:{id:"普通索引与唯一索引的选择"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#普通索引与唯一索引的选择"}},[s._v("#")]),s._v(" 普通索引与唯一索引的选择")]),s._v(" "),a("p",[s._v("假设执行查询的语句是select id from T where k=5,这个查询语句在索引树上查找的过程先是通过B+树从树根开始，按层搜索到叶子结点，然后可以认为数据页内部是通过二分查找来定位数据。")]),s._v(" "),a("ul",[a("li",[s._v("对于普通索引来讲，查找到满足条件的第一个记录k=5后，还需要查找到下一个记录，知道碰到第一个不满足k=5的记录退出。")]),s._v(" "),a("li",[s._v("对于唯一索引来说，由于索引定义了唯一性，查找到第一个满足条件的记录后，就会停止继续检索。")])]),s._v(" "),a("p",[s._v("这俩的性能实际上是没有区别的。")]),s._v(" "),a("p",[s._v("InnDB的数据是按照数据页为单位来进行读写的，也就是说，当需要读一条记录的时候，并不是将这个记录本身从磁盘上读下来，而是也页为单位，将整体读入内存。在InnoDB中每个数据页的大小默认是16kb。")]),s._v(" "),a("p",[s._v("因为引擎是按照页来读写的，所以当找到k=5 的记录时，他所在的数据页都在内存中，那么对于普通索引来说，需要多一次判断下一条记录是不是k=5,。")]),s._v(" "),a("p",[s._v("当然如果k=5这条记录刚好是这个数据页的最后一个记录，那么要取出这条记录，必须读取下一个数据页，这个操作会稍微复杂一些。")]),s._v(" "),a("p",[s._v("但是我们之前计算过，对于整形字段一个数据页可以放几千个key，因此出现这种情况的几率很低。")]),s._v(" "),a("p",[a("strong",[s._v("更新性能上两者的区别")])]),s._v(" "),a("p",[s._v("其实在查询上两者基本没差别，在更新性能上，建议使用普通索引。如果更新后面立即伴随的是对更新记录的查询，那应该是关闭change buffer，在其他情况下，change buffer都能提升更新性能。")]),s._v(" "),a("p",[a("strong",[s._v("什么是change buffer?")])]),s._v(" "),a("p",[s._v("当需要更新一个数据页的时候，如果数据页在内存中就直接更新，如果这个数据页没有字啊内存中的话，InnoDB会将这些更新操作缓存在change buffer中，这样就不需要从磁盘上读入这个数据页了，在下次查询需要访问这个数据页的时候，将数据页读入内存执行change buffer中与这个页有关的操作。通过这种方式就能保证数据逻辑的正确性。")]),s._v(" "),a("p",[s._v("将change buffer中的操作应用到原先数据页上得到的最新结果的过车高脚桌merge。除了访问这个数据页会触发merge，系统后台线程会定期merge，当数据正常关闭的过程中，也会执行merge操作。")]),s._v(" "),a("p",[a("strong",[s._v("什么时候可以使用change buffer")])]),s._v(" "),a("p",[s._v("对于唯一索引来说，所有的更新操作都要先判断这个操作是够违反唯一性约束，比如要插入(4,12)记录，就要先判断这个表中有没有k=4的记录，判断的话，就需要将这条记录读入内存，当然读入内存就不需要使用change buffer。")]),s._v(" "),a("p",[s._v("因此唯一索引的更新就不能使用change buffer，实际上也就普通索引可以使用。")]),s._v(" "),a("p",[s._v("change buffer的大小可以通过参数innodb_change_buffer_max_size来动态设置。这个参数设置为50的时候表示change buffer最大只能占用 buffer pool的50%。")]),s._v(" "),a("p",[a("strong",[s._v("如果要向表中插入一个新纪录的话，InnoDB的处理机制是怎样的?")])]),s._v(" "),a("p",[s._v("第一种情况是，"),a("strong",[s._v("这个记录要更新的目标页在内存中")]),s._v("。这时，InnoDB 的处理流程如下：")]),s._v(" "),a("ul",[a("li",[s._v("对于唯一索引来说，找到 3 和 5 之间的位置，判断到没有冲突，插入这个值，语句执行结束；")]),s._v(" "),a("li",[s._v("对于普通索引来说，找到 3 和 5 之间的位置，插入这个值，语句执行结束。")])]),s._v(" "),a("p",[s._v("这样看来，普通索引和唯一索引对更新语句性能影响的差别，只是一个判断，只会耗费微小的 CPU 时间。")]),s._v(" "),a("p",[s._v("但，这不是我们关注的重点。")]),s._v(" "),a("p",[s._v("第二种情况是，"),a("strong",[s._v("这个记录要更新的目标页不在内存中")]),s._v("。这时，InnoDB 的处理流程如下：")]),s._v(" "),a("ul",[a("li",[s._v("对于唯一索引来说，需要将数据页读入内存，判断到没有冲突，插入这个值，语句执行结束；")]),s._v(" "),a("li",[s._v("对于普通索引来说，则是将更新记录在 change buffer，语句执行就结束了。")])]),s._v(" "),a("p",[s._v("将数据从磁盘读入内存涉及随机 IO 的访问，是数据库里面成本最高的操作之一。change buffer 因为减少了随机磁盘访问，所以对更新性能的提升是会很明显的。")]),s._v(" "),a("p",[a("strong",[s._v("适用场景")])]),s._v(" "),a("p",[s._v("读多写少别用change buffer ；写多读少，change buffer的效果更好。在一个数据页做 merge 之前，change buffer 记录的变更越多（也就是这个页面上要更新的次数越多），收益就越大。")])])}),[],!1,null,null,null);t.default=e.exports}}]);