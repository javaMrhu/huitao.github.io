<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL索引详解 | 大涛的技术博客</title>
    <meta name="generator" content="VuePress 1.6.0">
    <link rel="icon" href="/img/icon.png">
    <meta name="description" content="灵魂在游走，程序在奔跑">
    <link rel="preload" href="/assets/css/0.styles.6d4461d5.css" as="style"><link rel="preload" href="/assets/js/app.61c80fcc.js" as="script"><link rel="preload" href="/assets/js/2.10aa6be6.js" as="script"><link rel="preload" href="/assets/js/7.17b60680.js" as="script"><link rel="prefetch" href="/assets/js/10.9496497a.js"><link rel="prefetch" href="/assets/js/11.8118b41d.js"><link rel="prefetch" href="/assets/js/12.4376467d.js"><link rel="prefetch" href="/assets/js/13.9efe1006.js"><link rel="prefetch" href="/assets/js/14.3b12e8ba.js"><link rel="prefetch" href="/assets/js/15.ce49387a.js"><link rel="prefetch" href="/assets/js/16.604bd4d7.js"><link rel="prefetch" href="/assets/js/17.e41f8b7a.js"><link rel="prefetch" href="/assets/js/18.1e6a8684.js"><link rel="prefetch" href="/assets/js/19.ef16a9c3.js"><link rel="prefetch" href="/assets/js/20.782c94c6.js"><link rel="prefetch" href="/assets/js/21.fe22e5dc.js"><link rel="prefetch" href="/assets/js/22.f51f8fe7.js"><link rel="prefetch" href="/assets/js/23.06b17ad2.js"><link rel="prefetch" href="/assets/js/24.b2ea8b88.js"><link rel="prefetch" href="/assets/js/25.2adb927e.js"><link rel="prefetch" href="/assets/js/26.cffa2406.js"><link rel="prefetch" href="/assets/js/27.f54bc382.js"><link rel="prefetch" href="/assets/js/28.a6e277c5.js"><link rel="prefetch" href="/assets/js/29.53561dfd.js"><link rel="prefetch" href="/assets/js/3.235d1e32.js"><link rel="prefetch" href="/assets/js/30.d1b7c92d.js"><link rel="prefetch" href="/assets/js/31.b0bb179f.js"><link rel="prefetch" href="/assets/js/32.fe2c6ecb.js"><link rel="prefetch" href="/assets/js/33.6a3be61e.js"><link rel="prefetch" href="/assets/js/34.0c674d89.js"><link rel="prefetch" href="/assets/js/35.acc90f64.js"><link rel="prefetch" href="/assets/js/36.ce73191e.js"><link rel="prefetch" href="/assets/js/37.01e2bad6.js"><link rel="prefetch" href="/assets/js/4.33f1dec2.js"><link rel="prefetch" href="/assets/js/5.7b3484b3.js"><link rel="prefetch" href="/assets/js/6.b398be66.js"><link rel="prefetch" href="/assets/js/8.aab7e4c8.js"><link rel="prefetch" href="/assets/js/9.8404322e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6d4461d5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><main><!----> <div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">大涛的技术博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/Life/" class="nav-link">
  Life
</a></div><div class="nav-item"><a href="/FAQ/" class="nav-link">
  求索
</a></div><div class="nav-item"><a href="/Grow/" class="nav-link">
  成长
</a></div><div class="nav-item"><a href="https://blog.csdn.net/qq_43672652" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://juejin.im/user/272334615478478" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://itdatao.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="/Life/" class="nav-link">
  Life
</a></div><div class="nav-item"><a href="/FAQ/" class="nav-link">
  求索
</a></div><div class="nav-item"><a href="/Grow/" class="nav-link">
  成长
</a></div><div class="nav-item"><a href="https://blog.csdn.net/qq_43672652" target="_blank" rel="noopener noreferrer" class="nav-link external">
  CSDN
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://juejin.im/user/272334615478478" target="_blank" rel="noopener noreferrer" class="nav-link external">
  掘金
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://itdatao.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-labelledby="outbound-link-title" role="img" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><title id="outbound-link-title">(opens new window)</title> <path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Data Base</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/DataBase/索引.html" class="active sidebar-link">MySQL索引详解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/DataBase/索引.html#常见的索引模型" class="sidebar-link">常见的索引模型</a></li><li class="sidebar-sub-header"><a href="/DataBase/索引.html#innodb索引模型" class="sidebar-link">InnoDB索引模型</a></li><li class="sidebar-sub-header"><a href="/DataBase/索引.html#索引的维护" class="sidebar-link">索引的维护</a></li><li class="sidebar-sub-header"><a href="/DataBase/索引.html#覆盖索引" class="sidebar-link">覆盖索引</a></li><li class="sidebar-sub-header"><a href="/DataBase/索引.html#最左前缀匹配原则" class="sidebar-link">最左前缀匹配原则</a></li><li class="sidebar-sub-header"><a href="/DataBase/索引.html#索引下推" class="sidebar-link">索引下推</a></li><li class="sidebar-sub-header"><a href="/DataBase/索引.html#普通索引与唯一索引的选择" class="sidebar-link">普通索引与唯一索引的选择</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Design Pattern</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>FAQ</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Grow</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java并发</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Life</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Network</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mysql索引详解"><a href="#mysql索引详解" class="header-anchor">#</a> MySQL索引详解</h1> <h2 id="常见的索引模型"><a href="#常见的索引模型" class="header-anchor">#</a> 常见的索引模型</h2> <p>索引的出现是为了提高查询效率，但是实现索引的方式却很多，所以这里也就引入了索引模型的概念。可用于提高读写效率的数据结构有很多，这里有三种常见的数据结构作为索引来使用，分别是哈希表，有序数组和搜索树。</p> <p>哈希表是一种以键值对存储的数据结构，用hash函数把key换算成一个确定的位置，然后把value放在数组的这个位置上。</p> <p>多个key经过哈希函数的计算可能会出现同一个值。处理这种情况的方法是，拉出一个链表。</p> <p>但是这个链表对于增加的新节点很快，缺点是因为链表不是有序的，所以索引做区间查询的速度是很慢的。</p> <p>因此哈希表这个结构适用于只有等值查询的场景。比如Memcached以及一些NoSQL引擎。</p> <p>而有序数组在等值查询和范围查询场景中的性能就是非常优秀的。</p> <p>因为这个索引如果是递增的顺序，我们就可以用二分查找找出对应的值，时间复杂度是O(logN)。</p> <p>同时，这个索引支持范围查询，你要查身份证号在[x,y]区间的User，可以先用二分查找找到x，然后向右遍历，查到第一个大于y的值，退出循环。</p> <p>如果仅仅看查询效率，有序数组就是最好的数据结构了，但是在需要更新数据的时候就很麻烦。因为数组增加一个值，需要往后挪动所有的记录，成本太高。</p> <p>因此，有序数组索引只适用于静态存储引擎。</p> <p>第三种是二叉搜索树。他的特点就是左孩子节点小于父节点，右孩子节点大于父节点。</p> <p><img src="https://gitee.com/bailefolen/typora-pictures/raw/master/typora-pictures/img/image-20201011202143603.png" alt="image-20201011202143603"></p> <p>要想查User2的ID_card，搜索顺序就是 UserA-&gt;UserC-&gt;UserF-&gt;User2.时间复杂度是O(log(N))。</p> <p>要想维持这个查询复杂度，就需要保证这始终是一颗平衡二叉树。为了做这个保证，更新的时间复杂度也是O(log(N))。</p> <p>虽然二叉树搜索效率很高，但是实际上大多数的数据库存储并不是使用二叉树作为存储，因为索引不止存在于内存中，还要写在磁盘上。</p> <p>为了再查询时尽量少读磁盘，就必须让查询过程访问尽量少的数据块。那么就要使用N叉树。N的大小取决于数据块的大小。</p> <p>数据库底层存储的核心是基于这些数据结构的。</p> <h2 id="innodb索引模型"><a href="#innodb索引模型" class="header-anchor">#</a> InnoDB索引模型</h2> <p>表都是根据主键顺序以索引的形式存放的。这种存储方式的表称为索引组织表。InnoDB使用了B+树索引模型，因此数据都是存储在B+树中的。</p> <p>每个索引在InnoDB里面对应一棵B+树。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">create</span> <span class="token keyword">table</span> T<span class="token punctuation">(</span>
id <span class="token keyword">int</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span> 
k <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span> 
name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">index</span> <span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>表中 R1~R5 的 (ID,k) 值分别为 (100,1)、(200,2)、(300,3)、(500,5) 和 (600,6)，两棵树的示例示意图如下。</p> <p><img src="https://gitee.com/bailefolen/typora-pictures/raw/master/typora-pictures/img/image-20201011203259230.png" alt="image-20201011203259230"></p> <p>索引分为两种，一种是主键索引，一种是非主键索引。</p> <p>主键索引的叶子结点存的是整行数据，在InnoDB里面，主键索引也被叫做聚簇索引。非主键索引的叶子结点存储的是主键的值，在InnoDB里面，非主键索引也被称为二级索引。</p> <p>说了这么多，这俩到底有啥区别？</p> <p>举个例子来说。</p> <p>如果语句是<code>select * from T where ID=500</code>，这是主键查询的方式，只需要搜索ID这颗B+树；</p> <p>如果语句是	<code>select * from T where k=5</code>也就是使用普通索引查询，需要先搜索k这颗索引树，得到ID的值是500，再到ID索引树搜索一次，这个过程叫做回表。</p> <p>也就是说，基于非主键索引的查询需要多扫描一棵索引树。因此，我们在应用中应该尽量使用主键查询。</p> <h2 id="索引的维护"><a href="#索引的维护" class="header-anchor">#</a> 索引的维护</h2> <p>B+树为了维护索引的有序性，如果新增的记录可以放在当前数据页，这个比较简单，但是如果当新增的记录加上去后，当前页已满，根据B+树的算法，这时候需要申请一个新的数据页，然后挪动部分数据过去，这个过程叫做页分裂。</p> <p>页分裂这玩意儿，除了影响性能外还影响数据页的利用率，原本放在一个页的数据，现在分到两个页中，整体空间利用率降低了50%。</p> <p>既然有分裂就会有合并，当相邻两个页由于删除了数据，利用率很低之后，会将数据页合并。合并的过程，就是分裂过程的可逆。</p> <p>自增主键，也就是如果不指定id的值，系统会获取当前id最大值加1作为下一条记录的ID值。</p> <p>自增主键的插入数据模式，正符合我们前面提到的递增插入的场景。每次插入一条记录，都是追加的操作，都不涉及挪动其它记录，也不会触发叶子结点的分裂。</p> <p>业务逻辑的字段做主键，则往往不容易保证有序插入，这样写数据成本相对较高。</p> <p>除了考虑性能外，我们还可以从存储空间的角度来看。</p> <p>直接说结论吧，主键长度越小，普通索引的叶子结点就越小，普通索引占用的空间也就越小。</p> <p>操作索引</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">alter</span> <span class="token keyword">table</span> T <span class="token keyword">drop</span> <span class="token keyword">index</span> k<span class="token punctuation">;</span> <span class="token comment">-- 删除索引</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> T <span class="token keyword">add</span> <span class="token keyword">index</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">--增加索引</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>主键索引</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">alter</span> <span class="token keyword">table</span> T <span class="token keyword">drop</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">;</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> T <span class="token keyword">add</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="覆盖索引"><a href="#覆盖索引" class="header-anchor">#</a> 覆盖索引</h2> <p><code>select * from t where k between 3 and 5</code></p> <p>先看上面这一条SQL语句的执行流程。</p> <ol><li><p>在k索引树上找到k=3的记录，取得ID=300；</p></li> <li><p>再到ID索引树查到ID=300对应的值</p></li> <li><p>在k索引树取下一个值k=5，取得ID=500；</p></li> <li><p>再回到ID索引树查到ID=500对应的R4。</p></li> <li><p>在k索引树取k=6不满足条件，退出循环。</p></li></ol> <p>在这个过程中，返回主键索引树了两次，也就是回表了两次。</p> <p>如果执行语句改为<code>select ID from t where k between 3 and 5</code>，这时候只需要查ID的值，而ID是组件，已经在普通索引树上了，因此可以直接提供查询结果，不需要回表。因为索引k覆盖了我们的查询需求，所以我们称为覆盖索引。</p> <p>因为覆盖索引可以减少回表次数，所以可以用来做性能优化。</p> <h2 id="最左前缀匹配原则"><a href="#最左前缀匹配原则" class="header-anchor">#</a> 最左前缀匹配原则</h2> <p>1、B+树的最左前缀匹配的原因</p> <p>MySQL创建联合索引的规则是根据索引最左边的字段进行排序，在第一个字段排序的基础上再进行第二个字段的排序，类似于order by col1,clo2所以第一个字段是绝对有序的，第二个字段就是无序的，所以MySQL强调最左前缀匹配。</p> <p>比如a=3 and b=4 and c&gt;5 and d=6，如果建立abcd的联合索引，d就用不到索引，因为MySQL会一直向右匹配直到遇到范围查询（between and ，&gt;， &lt;， like）。</p> <h2 id="索引下推"><a href="#索引下推" class="header-anchor">#</a> 索引下推</h2> <p>建一张市民表</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>tuser<span class="token punctuation">`</span> <span class="token punctuation">(</span>
<span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">`</span>id_card<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">`</span>age<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
<span class="token punctuation">`</span>ismale<span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">KEY</span> <span class="token punctuation">`</span>id_card<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id_card<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">KEY</span> <span class="token punctuation">`</span>name_age<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>age<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>现在要查姓张的男孩年龄还必须是10岁的，SQL可以这么写</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>
mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tuser <span class="token keyword">where</span> name <span class="token operator">like</span> <span class="token string">'张 %'</span> <span class="token operator">and</span> age<span class="token operator">=</span><span class="token number">10</span> <span class="token operator">and</span> ismale<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这个语句在搜索 索引树的时候，只能用&quot;张&quot;,找到第一个满足条件的记录ID3，当然这种笔全表扫描要好。然后再判断剩下的条件是否满足，在MySQL5.6版本之前只能根据name查到ID3，剩下的条件需要一次一次回表判断才能最终找出结果。但是在MySQL5.6引入下推优化，可以减少回表的次数。</p> <p>5.6之前，不会向后判断age，而是直接回表查询
<img src="https://gitee.com/bailefolen/typora-pictures/raw/master/typora-pictures/img/2020050122433743.png" alt="在这里插入图片描述"></p> <p>5.6之后，会向后判断age=10的人，然后再回表，这样就减少了回表的次数</p> <p><img src="https://gitee.com/bailefolen/typora-pictures/raw/master/typora-pictures/img/20200501224320395.png" alt="在这里插入图片描述"></p> <h2 id="普通索引与唯一索引的选择"><a href="#普通索引与唯一索引的选择" class="header-anchor">#</a> 普通索引与唯一索引的选择</h2> <p>假设执行查询的语句是select id from T where k=5,这个查询语句在索引树上查找的过程先是通过B+树从树根开始，按层搜索到叶子结点，然后可以认为数据页内部是通过二分查找来定位数据。</p> <ul><li>对于普通索引来讲，查找到满足条件的第一个记录k=5后，还需要查找到下一个记录，知道碰到第一个不满足k=5的记录退出。</li> <li>对于唯一索引来说，由于索引定义了唯一性，查找到第一个满足条件的记录后，就会停止继续检索。</li></ul> <p>这俩的性能实际上是没有区别的。</p> <p>InnDB的数据是按照数据页为单位来进行读写的，也就是说，当需要读一条记录的时候，并不是将这个记录本身从磁盘上读下来，而是也页为单位，将整体读入内存。在InnoDB中每个数据页的大小默认是16kb。</p> <p>因为引擎是按照页来读写的，所以当找到k=5 的记录时，他所在的数据页都在内存中，那么对于普通索引来说，需要多一次判断下一条记录是不是k=5,。</p> <p>当然如果k=5这条记录刚好是这个数据页的最后一个记录，那么要取出这条记录，必须读取下一个数据页，这个操作会稍微复杂一些。</p> <p>但是我们之前计算过，对于整形字段一个数据页可以放几千个key，因此出现这种情况的几率很低。</p> <p><strong>更新性能上两者的区别</strong></p> <p>其实在查询上两者基本没差别，在更新性能上，建议使用普通索引。如果更新后面立即伴随的是对更新记录的查询，那应该是关闭change buffer，在其他情况下，change buffer都能提升更新性能。</p> <p><strong>什么是change buffer?</strong></p> <p>当需要更新一个数据页的时候，如果数据页在内存中就直接更新，如果这个数据页没有字啊内存中的话，InnoDB会将这些更新操作缓存在change buffer中，这样就不需要从磁盘上读入这个数据页了，在下次查询需要访问这个数据页的时候，将数据页读入内存执行change buffer中与这个页有关的操作。通过这种方式就能保证数据逻辑的正确性。</p> <p>将change buffer中的操作应用到原先数据页上得到的最新结果的过车高脚桌merge。除了访问这个数据页会触发merge，系统后台线程会定期merge，当数据正常关闭的过程中，也会执行merge操作。</p> <p><strong>什么时候可以使用change buffer</strong></p> <p>对于唯一索引来说，所有的更新操作都要先判断这个操作是够违反唯一性约束，比如要插入(4,12)记录，就要先判断这个表中有没有k=4的记录，判断的话，就需要将这条记录读入内存，当然读入内存就不需要使用change buffer。</p> <p>因此唯一索引的更新就不能使用change buffer，实际上也就普通索引可以使用。</p> <p>change buffer的大小可以通过参数innodb_change_buffer_max_size来动态设置。这个参数设置为50的时候表示change buffer最大只能占用 buffer pool的50%。</p> <p><strong>如果要向表中插入一个新纪录的话，InnoDB的处理机制是怎样的?</strong></p> <p>第一种情况是，<strong>这个记录要更新的目标页在内存中</strong>。这时，InnoDB 的处理流程如下：</p> <ul><li>对于唯一索引来说，找到 3 和 5 之间的位置，判断到没有冲突，插入这个值，语句执行结束；</li> <li>对于普通索引来说，找到 3 和 5 之间的位置，插入这个值，语句执行结束。</li></ul> <p>这样看来，普通索引和唯一索引对更新语句性能影响的差别，只是一个判断，只会耗费微小的 CPU 时间。</p> <p>但，这不是我们关注的重点。</p> <p>第二种情况是，<strong>这个记录要更新的目标页不在内存中</strong>。这时，InnoDB 的处理流程如下：</p> <ul><li>对于唯一索引来说，需要将数据页读入内存，判断到没有冲突，插入这个值，语句执行结束；</li> <li>对于普通索引来说，则是将更新记录在 change buffer，语句执行就结束了。</li></ul> <p>将数据从磁盘读入内存涉及随机 IO 的访问，是数据库里面成本最高的操作之一。change buffer 因为减少了随机磁盘访问，所以对更新性能的提升是会很明显的。</p> <p><strong>适用场景</strong></p> <p>读多写少别用change buffer ；写多读少，change buffer的效果更好。在一个数据页做 merge 之前，change buffer 记录的变更越多（也就是这个页面上要更新的次数越多），收益就越大。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/DesignPattern/设计模式也可以这么简单.html">
        设计模式也可以这么简单
      </a>
      →
    </span></p></div> </main></div> <!----></main><div class="global-ui"><div></div><div id="live2d-widget" class="live2d-widget-container" style="position:fixed;right:65px;bottom:0px;width:135px;height:300px;z-index:99999;opacity:0.8;pointer-events:none;"><canvas id="live2d_canvas" width="135" height="300" class="live2d_canvas" style="position:absolute;left:0px;top:0px;width:135px;height:300px;"></canvas></div></div></div>
    <script src="/assets/js/app.61c80fcc.js" defer></script><script src="/assets/js/2.10aa6be6.js" defer></script><script src="/assets/js/7.17b60680.js" defer></script>
  </body>
</html>
